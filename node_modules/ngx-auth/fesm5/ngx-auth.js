import { InjectionToken, Injectable, Inject, Injector, NgModule } from '@angular/core';
import { Router } from '@angular/router';
import { map, first, switchMap, catchError } from 'rxjs/operators';
import { __spread } from 'tslib';
import { HttpClient, HTTP_INTERCEPTORS } from '@angular/common/http';
import { Subject, throwError } from 'rxjs';

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/**
 * Essential service for authentication
 * @abstract
 */
var  /**
 * Essential service for authentication
 * @abstract
 */
AuthService = /** @class */ (function () {
    function AuthService() {
    }
    return AuthService;
}());

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/** @type {?} */
var AUTH_SERVICE = new InjectionToken('AUTH_SERVICE');
/** @type {?} */
var PUBLIC_FALLBACK_PAGE_URI = new InjectionToken('PUBLIC_FALLBACK_PAGE_URI');
/** @type {?} */
var PROTECTED_FALLBACK_PAGE_URI = new InjectionToken('PROTECTED_FALLBACK_PAGE_URI');

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/**
 * Guard, checks access token availability and allows or disallows access to page,
 * and redirects out
 *
 * usage: { path: 'test', component: TestComponent, canActivate: [ PublicGuard ] }
 *
 * @export
 */
var PublicGuard = /** @class */ (function () {
    function PublicGuard(authService, protectedFallbackPageUri, router) {
        this.authService = authService;
        this.protectedFallbackPageUri = protectedFallbackPageUri;
        this.router = router;
    }
    /**
     * CanActivate handler
     */
    /**
     * CanActivate handler
     * @param {?} _route
     * @param {?} state
     * @return {?}
     */
    PublicGuard.prototype.canActivate = /**
     * CanActivate handler
     * @param {?} _route
     * @param {?} state
     * @return {?}
     */
    function (_route, state) {
        var _this = this;
        return this.authService.isAuthorized()
            .pipe(map(function (isAuthorized) {
            if (isAuthorized && !_this.isProtectedPage(state)) {
                _this.navigate(_this.protectedFallbackPageUri);
                return false;
            }
            return true;
        }));
    };
    /**
     * CanActivateChild handler
     */
    /**
     * CanActivateChild handler
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    PublicGuard.prototype.canActivateChild = /**
     * CanActivateChild handler
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    function (route, state) {
        return this.canActivate(route, state);
    };
    /**
     * Check, if current page is protected fallback page
     */
    /**
     * Check, if current page is protected fallback page
     * @param {?} state
     * @return {?}
     */
    PublicGuard.prototype.isProtectedPage = /**
     * Check, if current page is protected fallback page
     * @param {?} state
     * @return {?}
     */
    function (state) {
        return state.url === this.protectedFallbackPageUri;
    };
    /**
     * Navigate away from the app / path
     */
    /**
     * Navigate away from the app / path
     * @param {?} url
     * @return {?}
     */
    PublicGuard.prototype.navigate = /**
     * Navigate away from the app / path
     * @param {?} url
     * @return {?}
     */
    function (url) {
        if (url.startsWith('http')) {
            window.location.href = url;
        }
        else {
            this.router.navigateByUrl(url);
        }
    };
    PublicGuard.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    PublicGuard.ctorParameters = function () { return [
        { type: AuthService, decorators: [{ type: Inject, args: [AUTH_SERVICE,] }] },
        { type: String, decorators: [{ type: Inject, args: [PROTECTED_FALLBACK_PAGE_URI,] }] },
        { type: Router }
    ]; };
    return PublicGuard;
}());

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
/**
 * Guard, checks access token availability and allows or disallows access to page,
 * and redirects out
 *
 * usage: { path: 'test', component: TestComponent, canActivate: [ AuthGuard ] }
 *
 * @export
 */
var ProtectedGuard = /** @class */ (function () {
    function ProtectedGuard(authService, publicFallbackPageUri, router) {
        this.authService = authService;
        this.publicFallbackPageUri = publicFallbackPageUri;
        this.router = router;
    }
    /**
     * CanActivate handler
     */
    /**
     * CanActivate handler
     * @param {?} _route
     * @param {?} state
     * @return {?}
     */
    ProtectedGuard.prototype.canActivate = /**
     * CanActivate handler
     * @param {?} _route
     * @param {?} state
     * @return {?}
     */
    function (_route, state) {
        var _this = this;
        return this.authService.isAuthorized()
            .pipe(map(function (isAuthorized) {
            if (!isAuthorized && !_this.isPublicPage(state)) {
                if (_this.authService.setInterruptedUrl) {
                    _this.authService.setInterruptedUrl(state.url);
                }
                _this.navigate(_this.publicFallbackPageUri);
                return false;
            }
            return true;
        }));
    };
    /**
     * CanActivateChild handler
     */
    /**
     * CanActivateChild handler
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    ProtectedGuard.prototype.canActivateChild = /**
     * CanActivateChild handler
     * @param {?} route
     * @param {?} state
     * @return {?}
     */
    function (route, state) {
        return this.canActivate(route, state);
    };
    /**
     * Check, if current page is public fallback page
     */
    /**
     * Check, if current page is public fallback page
     * @param {?} state
     * @return {?}
     */
    ProtectedGuard.prototype.isPublicPage = /**
     * Check, if current page is public fallback page
     * @param {?} state
     * @return {?}
     */
    function (state) {
        return state.url === this.publicFallbackPageUri;
    };
    /**
     * Navigate away from the app / path
     */
    /**
     * Navigate away from the app / path
     * @param {?} url
     * @return {?}
     */
    ProtectedGuard.prototype.navigate = /**
     * Navigate away from the app / path
     * @param {?} url
     * @return {?}
     */
    function (url) {
        if (url.startsWith('http')) {
            window.location.href = url;
        }
        else {
            this.router.navigateByUrl(url);
        }
    };
    ProtectedGuard.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ProtectedGuard.ctorParameters = function () { return [
        { type: AuthService, decorators: [{ type: Inject, args: [AUTH_SERVICE,] }] },
        { type: String, decorators: [{ type: Inject, args: [PUBLIC_FALLBACK_PAGE_URI,] }] },
        { type: Router }
    ]; };
    return ProtectedGuard;
}());

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
var AuthInterceptor = /** @class */ (function () {
    function AuthInterceptor(injector) {
        this.injector = injector;
        /**
         * Is refresh token is being executed
         */
        this.refreshInProgress = false;
        /**
         * Notify all outstanding requests through this subject
         */
        this.refreshSubject = new Subject();
    }
    /**
     * Intercept an outgoing `HttpRequest`
     */
    /**
     * Intercept an outgoing `HttpRequest`
     * @param {?} req
     * @param {?} delegate
     * @return {?}
     */
    AuthInterceptor.prototype.intercept = /**
     * Intercept an outgoing `HttpRequest`
     * @param {?} req
     * @param {?} delegate
     * @return {?}
     */
    function (req, delegate) {
        if (this.skipRequest(req)) {
            return delegate.handle(req);
        }
        return this.processIntercept(req, delegate);
    };
    /**
     * Process all the requests via custom interceptors.
     */
    /**
     * Process all the requests via custom interceptors.
     * @param {?} original
     * @param {?} delegate
     * @return {?}
     */
    AuthInterceptor.prototype.processIntercept = /**
     * Process all the requests via custom interceptors.
     * @param {?} original
     * @param {?} delegate
     * @return {?}
     */
    function (original, delegate) {
        var _this = this;
        /** @type {?} */
        var clone = original.clone();
        return this.request(clone)
            .pipe(switchMap(function (req) { return delegate.handle(req); }), catchError(function (res) { return _this.responseError(clone, res); }));
    };
    /**
     * Request interceptor. Delays request if refresh is in progress
     * otherwise adds token to the headers
     */
    /**
     * Request interceptor. Delays request if refresh is in progress
     * otherwise adds token to the headers
     * @param {?} req
     * @return {?}
     */
    AuthInterceptor.prototype.request = /**
     * Request interceptor. Delays request if refresh is in progress
     * otherwise adds token to the headers
     * @param {?} req
     * @return {?}
     */
    function (req) {
        if (this.refreshInProgress) {
            return this.delayRequest(req);
        }
        return this.addToken(req);
    };
    /**
     * Failed request interceptor, check if it has to be processed with refresh
     */
    /**
     * Failed request interceptor, check if it has to be processed with refresh
     * @param {?} req
     * @param {?} res
     * @return {?}
     */
    AuthInterceptor.prototype.responseError = /**
     * Failed request interceptor, check if it has to be processed with refresh
     * @param {?} req
     * @param {?} res
     * @return {?}
     */
    function (req, res) {
        var _this = this;
        /** @type {?} */
        var authService = this.injector.get(AUTH_SERVICE);
        /** @type {?} */
        var refreshShouldHappen = authService.refreshShouldHappen(res);
        if (refreshShouldHappen && !this.refreshInProgress) {
            this.refreshInProgress = true;
            authService
                .refreshToken()
                .subscribe(function () {
                _this.refreshInProgress = false;
                _this.refreshSubject.next(true);
            }, function () {
                _this.refreshInProgress = false;
                _this.refreshSubject.next(false);
            });
        }
        if (refreshShouldHappen && this.refreshInProgress) {
            return this.retryRequest(req, res);
        }
        return throwError(res);
    };
    /**
     * Add access token to headers or the request
     */
    /**
     * Add access token to headers or the request
     * @param {?} req
     * @return {?}
     */
    AuthInterceptor.prototype.addToken = /**
     * Add access token to headers or the request
     * @param {?} req
     * @return {?}
     */
    function (req) {
        /** @type {?} */
        var authService = this.injector.get(AUTH_SERVICE);
        return authService.getAccessToken()
            .pipe(map(function (token) {
            if (token) {
                /** @type {?} */
                var setHeaders = void 0;
                if (typeof authService.getHeaders === 'function') {
                    setHeaders = authService.getHeaders(token);
                }
                else {
                    setHeaders = { Authorization: "Bearer " + token };
                }
                return req.clone({ setHeaders: setHeaders });
            }
            return req;
        }), first());
    };
    /**
     * Delay request, by subscribing on refresh event, once it finished, process it
     * otherwise throw error
     */
    /**
     * Delay request, by subscribing on refresh event, once it finished, process it
     * otherwise throw error
     * @param {?} req
     * @return {?}
     */
    AuthInterceptor.prototype.delayRequest = /**
     * Delay request, by subscribing on refresh event, once it finished, process it
     * otherwise throw error
     * @param {?} req
     * @return {?}
     */
    function (req) {
        var _this = this;
        return this.refreshSubject.pipe(first(), switchMap(function (status) {
            return status ? _this.addToken(req) : throwError(req);
        }));
    };
    /**
     * Retry request, by subscribing on refresh event, once it finished, process it
     * otherwise throw error
     */
    /**
     * Retry request, by subscribing on refresh event, once it finished, process it
     * otherwise throw error
     * @param {?} req
     * @param {?} res
     * @return {?}
     */
    AuthInterceptor.prototype.retryRequest = /**
     * Retry request, by subscribing on refresh event, once it finished, process it
     * otherwise throw error
     * @param {?} req
     * @param {?} res
     * @return {?}
     */
    function (req, res) {
        /** @type {?} */
        var http = this.injector.get(HttpClient);
        return this.refreshSubject.pipe(first(), switchMap(function (status) {
            return status ? http.request(req) : throwError(res || req);
        }));
    };
    /**
     * Checks if request must be skipped by interceptor.
     */
    /**
     * Checks if request must be skipped by interceptor.
     * @param {?} req
     * @return {?}
     */
    AuthInterceptor.prototype.skipRequest = /**
     * Checks if request must be skipped by interceptor.
     * @param {?} req
     * @return {?}
     */
    function (req) {
        /** @type {?} */
        var skipRequest = this.exec('skipRequest', req);
        /** @type {?} */
        var verifyRefreshToken = this.exec('verifyRefreshToken', req);
        // deprecated, will be removed soon
        /** @type {?} */
        var verifyTokenRequest = this.exec('verifyTokenRequest', req.url);
        return skipRequest || verifyRefreshToken || verifyTokenRequest;
    };
    /**
     * Exec optional method, will be removed in upcoming updates.
     * Temp method until `verifyTokenRequest` will be completely replaced with skipRequest
     */
    /**
     * Exec optional method, will be removed in upcoming updates.
     * Temp method until `verifyTokenRequest` will be completely replaced with skipRequest
     * @param {?} method
     * @param {...?} args
     * @return {?}
     */
    AuthInterceptor.prototype.exec = /**
     * Exec optional method, will be removed in upcoming updates.
     * Temp method until `verifyTokenRequest` will be completely replaced with skipRequest
     * @param {?} method
     * @param {...?} args
     * @return {?}
     */
    function (method) {
        var args = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            args[_i - 1] = arguments[_i];
        }
        /** @type {?} */
        var authService = this.injector.get(AUTH_SERVICE);
        if (typeof authService[method] === 'function') {
            return authService[method].apply(authService, __spread(args));
        }
    };
    AuthInterceptor.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    AuthInterceptor.ctorParameters = function () { return [
        { type: Injector }
    ]; };
    return AuthInterceptor;
}());

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
var AuthModule = /** @class */ (function () {
    function AuthModule() {
    }
    AuthModule.decorators = [
        { type: NgModule, args: [{
                    providers: [
                        PublicGuard,
                        ProtectedGuard,
                        AuthInterceptor,
                        {
                            provide: HTTP_INTERCEPTORS,
                            useClass: AuthInterceptor,
                            multi: true,
                        }
                    ]
                },] }
    ];
    return AuthModule;
}());

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */

/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */

export { AuthService, PublicGuard, ProtectedGuard, AUTH_SERVICE, PUBLIC_FALLBACK_PAGE_URI, PROTECTED_FALLBACK_PAGE_URI, AuthModule, AuthInterceptor as ɵa };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWF1dGguanMubWFwIiwic291cmNlcyI6WyJuZzovL25neC1hdXRoL2F1dGguc2VydmljZS50cyIsIm5nOi8vbmd4LWF1dGgvdG9rZW5zLnRzIiwibmc6Ly9uZ3gtYXV0aC9wdWJsaWMuZ3VhcmQudHMiLCJuZzovL25neC1hdXRoL3Byb3RlY3RlZC5ndWFyZC50cyIsIm5nOi8vbmd4LWF1dGgvYXV0aC5pbnRlcmNlcHRvci50cyIsIm5nOi8vbmd4LWF1dGgvYXV0aC5tb2R1bGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cFJlcXVlc3QsIEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG4vKipcbiAqIEVzc2VudGlhbCBzZXJ2aWNlIGZvciBhdXRoZW50aWNhdGlvblxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQXV0aFNlcnZpY2Uge1xuXG4gIC8qKlxuICAgKiBDaGVjaywgaWYgdXNlciBhbHJlYWR5IGF1dGhvcml6ZWQuXG4gICAqIFNob3VsZCByZXR1cm4gT2JzZXJ2YWJsZSB3aXRoIHRydWUgb3IgZmFsc2UgdmFsdWVzXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgaXNBdXRob3JpemVkKCk6IE9ic2VydmFibGU8Ym9vbGVhbj47XG5cbiAgLyoqXG4gICAqIEdldCBhY2Nlc3MgdG9rZW5cbiAgICogU2hvdWxkIHJldHVybiBhY2Nlc3MgdG9rZW4gaW4gT2JzZXJ2YWJsZSBmcm9tIGUuZy5cbiAgICogbG9jYWxTdG9yYWdlXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgZ2V0QWNjZXNzVG9rZW4oKTogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiwgdGhhdCBzaG91bGQgcGVyZm9ybSByZWZyZXNoIHRva2VuXG4gICAqIFNob3VsZCBiZSBzdWNjZXNzZnVsbHkgY29tcGxldGVkIHNvIGludGVyY2VwdG9yXG4gICAqIGNhbiBleGVjdXRlIHBlbmRpbmcgcmVxdWVzdHMgb3IgcmV0cnkgb3JpZ2luYWwgb25lXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgcmVmcmVzaFRva2VuKCk6IE9ic2VydmFibGU8YW55PjtcblxuICAvKipcbiAgICogRnVuY3Rpb24sIGNoZWNrcyByZXNwb25zZSBvZiBmYWlsZWQgcmVxdWVzdCB0byBkZXRlcm1pbmUsXG4gICAqIHdoZXRoZXIgdG9rZW4gYmUgcmVmcmVzaGVkIG9yIG5vdC5cbiAgICpcbiAgICogRXNzZW50aWFsbHkgY2hlY2tzIHN0YXR1c1xuICAgKi9cbiAgcHVibGljIGFic3RyYWN0IHJlZnJlc2hTaG91bGRIYXBwZW4ocmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlKTogYm9vbGVhbjtcblxuICAvKipcbiAgICogVmVyaWZ5IHRoYXQgb3V0Z29pbmcgcmVxdWVzdCBpcyByZWZyZXNoLXRva2VuLFxuICAgKiBzbyBpbnRlcmNlcHRvciB3b24ndCBpbnRlcmNlcHQgdGhpcyByZXF1ZXN0XG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgdmVyaWZ5UmVmcmVzaFRva2VuPyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogYm9vbGVhbjtcblxuICAvKipcbiAgICogQ2hlY2tzIGlmIHJlcXVlc3QgbXVzdCBiZSBza2lwcGVkIGJ5IGludGVyY2VwdG9yLlxuICAgKiBVc2VmdWwgZm9yIHJlcXVlc3RzIHN1Y2ggYXMgcmVxdWVzdCB0b2tlbiB3aGljaCBkb2Vzbid0IHJlcXVpcmUgdG9rZW4gaW4gaGVhZGVyc1xuICAgKi9cbiAgcHVibGljIGFic3RyYWN0IHNraXBSZXF1ZXN0PyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogYm9vbGVhbjtcblxuICAvKipcbiAgICogQWRkIHRva2VuIHRvIGhlYWRlcnMsIGRlcGVuZGVudCBvbiBzZXJ2ZXJcbiAgICogc2V0LXVwLCBieSBkZWZhdWx0IGFkZHMgYSBiZWFyZXIgdG9rZW4uXG4gICAqIENhbGxlZCBieSBpbnRlcmNlcHRvci5cbiAgICogVG8gY2hhbmdlIGJlaGF2aW9yLCBvdmVycmlkZSB0aGlzIG1ldGhvZC5cbiAgICovXG4gIHB1YmxpYyBhYnN0cmFjdCBnZXRIZWFkZXJzPyh0b2tlbjogc3RyaW5nKTogeyBbbmFtZTogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW10gfTtcblxuICAvKipcbiAgICogU2F2ZXMgbGFzdCBpbnRlcnJ1cHRlZCB1cmwgaW5zaWRlIG9mIHRoZSBzZXJ2aWNlIGZvciBmdXJ0aGVyIHJldXNhZ2UsXG4gICAqIGUuZy4gcmVzdG9yaW5nIGludGVycnVwdGVkIHBhZ2UgYWZ0ZXIgbG9nZ2luZyBpblxuICAgKi9cbiAgcHVibGljIGFic3RyYWN0IHNldEludGVycnVwdGVkVXJsPyh1cmw6IHN0cmluZyk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIFZlcmlmeSB0aGF0IG91dGdvaW5nIHJlcXVlc3QgaXMgcmVmcmVzaC10b2tlbixcbiAgICogc28gaW50ZXJjZXB0b3Igd29uJ3QgaW50ZXJjZXB0IHRoaXMgcmVxdWVzdFxuICAgKiBAZGVwcmVjYXRlZCBEdWUgdG8gaWxsb2dpY2FsIG1lYW5pbmcvZnVuY3Rpb25hbGl0eSB0aGlzIG1ldGhvZCBpcyBkZXByZWNhdGVkXG4gICAqIEBzZWUgdmVyaWZ5UmVmcmVzaFRva2VuXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgdmVyaWZ5VG9rZW5SZXF1ZXN0Pyh1cmw6IHN0cmluZyk6IGJvb2xlYW47XG59XG4iLCJpbXBvcnQgeyBJbmplY3Rpb25Ub2tlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5leHBvcnQgY29uc3QgQVVUSF9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuKCdBVVRIX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBQVUJMSUNfRkFMTEJBQ0tfUEFHRV9VUkkgPSBuZXcgSW5qZWN0aW9uVG9rZW4oJ1BVQkxJQ19GQUxMQkFDS19QQUdFX1VSSScpO1xuZXhwb3J0IGNvbnN0IFBST1RFQ1RFRF9GQUxMQkFDS19QQUdFX1VSSSA9IG5ldyBJbmplY3Rpb25Ub2tlbignUFJPVEVDVEVEX0ZBTExCQUNLX1BBR0VfVVJJJyk7XG4iLCJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIENhbkFjdGl2YXRlLFxuICBDYW5BY3RpdmF0ZUNoaWxkLFxuICBSb3V0ZXIsXG4gIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsXG4gIFJvdXRlclN0YXRlU25hcHNob3Rcbn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBBVVRIX1NFUlZJQ0UsIFBST1RFQ1RFRF9GQUxMQkFDS19QQUdFX1VSSSB9IGZyb20gJy4vdG9rZW5zJztcblxuLyoqXG4gKiBHdWFyZCwgY2hlY2tzIGFjY2VzcyB0b2tlbiBhdmFpbGFiaWxpdHkgYW5kIGFsbG93cyBvciBkaXNhbGxvd3MgYWNjZXNzIHRvIHBhZ2UsXG4gKiBhbmQgcmVkaXJlY3RzIG91dFxuICpcbiAqIHVzYWdlOiB7IHBhdGg6ICd0ZXN0JywgY29tcG9uZW50OiBUZXN0Q29tcG9uZW50LCBjYW5BY3RpdmF0ZTogWyBQdWJsaWNHdWFyZCBdIH1cbiAqXG4gKiBAZXhwb3J0XG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQdWJsaWNHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlLCBDYW5BY3RpdmF0ZUNoaWxkIHtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KEFVVEhfU0VSVklDRSkgcHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UsXG4gICAgQEluamVjdChQUk9URUNURURfRkFMTEJBQ0tfUEFHRV9VUkkpIHByaXZhdGUgcHJvdGVjdGVkRmFsbGJhY2tQYWdlVXJpOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlclxuICApIHt9XG5cbiAgLyoqXG4gICAqIENhbkFjdGl2YXRlIGhhbmRsZXJcbiAgICovXG4gIHB1YmxpYyBjYW5BY3RpdmF0ZShcbiAgICBfcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsXG4gICAgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3RcbiAgKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuYXV0aFNlcnZpY2UuaXNBdXRob3JpemVkKClcbiAgICAgIC5waXBlKG1hcCgoaXNBdXRob3JpemVkOiBib29sZWFuKSA9PiB7XG4gICAgICAgIGlmIChpc0F1dGhvcml6ZWQgJiYgIXRoaXMuaXNQcm90ZWN0ZWRQYWdlKHN0YXRlKSkge1xuICAgICAgICAgIHRoaXMubmF2aWdhdGUodGhpcy5wcm90ZWN0ZWRGYWxsYmFja1BhZ2VVcmkpO1xuXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9KSk7XG4gIH1cblxuICAvKipcbiAgICogQ2FuQWN0aXZhdGVDaGlsZCBoYW5kbGVyXG4gICAqL1xuICBwdWJsaWMgY2FuQWN0aXZhdGVDaGlsZChcbiAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCxcbiAgICBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdFxuICApOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5jYW5BY3RpdmF0ZShyb3V0ZSwgc3RhdGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrLCBpZiBjdXJyZW50IHBhZ2UgaXMgcHJvdGVjdGVkIGZhbGxiYWNrIHBhZ2VcbiAgICovXG4gIHByaXZhdGUgaXNQcm90ZWN0ZWRQYWdlKHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHN0YXRlLnVybCA9PT0gdGhpcy5wcm90ZWN0ZWRGYWxsYmFja1BhZ2VVcmk7XG4gIH1cblxuICAvKipcbiAgICogTmF2aWdhdGUgYXdheSBmcm9tIHRoZSBhcHAgLyBwYXRoXG4gICAqL1xuICBwcml2YXRlIG5hdmlnYXRlKHVybDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHVybC5zdGFydHNXaXRoKCdodHRwJykpIHtcbiAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gdXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHVybCk7XG4gICAgfVxuICB9XG5cbn1cbiIsImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgUm91dGVyLFxuICBDYW5BY3RpdmF0ZSxcbiAgQ2FuQWN0aXZhdGVDaGlsZCxcbiAgQWN0aXZhdGVkUm91dGVTbmFwc2hvdCxcbiAgUm91dGVyU3RhdGVTbmFwc2hvdFxufSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJy4vYXV0aC5zZXJ2aWNlJztcbmltcG9ydCB7IEFVVEhfU0VSVklDRSwgUFVCTElDX0ZBTExCQUNLX1BBR0VfVVJJIH0gZnJvbSAnLi90b2tlbnMnO1xuXG4vKipcbiAqIEd1YXJkLCBjaGVja3MgYWNjZXNzIHRva2VuIGF2YWlsYWJpbGl0eSBhbmQgYWxsb3dzIG9yIGRpc2FsbG93cyBhY2Nlc3MgdG8gcGFnZSxcbiAqIGFuZCByZWRpcmVjdHMgb3V0XG4gKlxuICogdXNhZ2U6IHsgcGF0aDogJ3Rlc3QnLCBjb21wb25lbnQ6IFRlc3RDb21wb25lbnQsIGNhbkFjdGl2YXRlOiBbIEF1dGhHdWFyZCBdIH1cbiAqXG4gKiBAZXhwb3J0XG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQcm90ZWN0ZWRHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlLCBDYW5BY3RpdmF0ZUNoaWxkIHtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KEFVVEhfU0VSVklDRSlwcml2YXRlIGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSxcbiAgICBASW5qZWN0KFBVQkxJQ19GQUxMQkFDS19QQUdFX1VSSSkgcHJpdmF0ZSBwdWJsaWNGYWxsYmFja1BhZ2VVcmk6IHN0cmluZyxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyXG4gICkge31cblxuICAvKipcbiAgICogQ2FuQWN0aXZhdGUgaGFuZGxlclxuICAgKi9cbiAgcHVibGljIGNhbkFjdGl2YXRlKFxuICAgIF9yb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCxcbiAgICBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdFxuICApOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5hdXRoU2VydmljZS5pc0F1dGhvcml6ZWQoKVxuICAgICAgLnBpcGUobWFwKChpc0F1dGhvcml6ZWQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgaWYgKCFpc0F1dGhvcml6ZWQgJiYgIXRoaXMuaXNQdWJsaWNQYWdlKHN0YXRlKSkge1xuICAgICAgICAgIGlmICh0aGlzLmF1dGhTZXJ2aWNlLnNldEludGVycnVwdGVkVXJsKSB7XG4gICAgICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlLnNldEludGVycnVwdGVkVXJsKHN0YXRlLnVybCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy5uYXZpZ2F0ZSh0aGlzLnB1YmxpY0ZhbGxiYWNrUGFnZVVyaSk7XG5cbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYW5BY3RpdmF0ZUNoaWxkIGhhbmRsZXJcbiAgICovXG4gIHB1YmxpYyBjYW5BY3RpdmF0ZUNoaWxkKFxuICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LFxuICAgIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLmNhbkFjdGl2YXRlKHJvdXRlLCBzdGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2ssIGlmIGN1cnJlbnQgcGFnZSBpcyBwdWJsaWMgZmFsbGJhY2sgcGFnZVxuICAgKi9cbiAgcHJpdmF0ZSBpc1B1YmxpY1BhZ2Uoc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3RhdGUudXJsID09PSB0aGlzLnB1YmxpY0ZhbGxiYWNrUGFnZVVyaTtcbiAgfVxuXG4gIC8qKlxuICAgKiBOYXZpZ2F0ZSBhd2F5IGZyb20gdGhlIGFwcCAvIHBhdGhcbiAgICovXG4gIHByaXZhdGUgbmF2aWdhdGUodXJsOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwodXJsKTtcbiAgICB9XG4gIH1cblxufVxuIiwiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEh0dHBDbGllbnQsXG4gIEh0dHBFdmVudCxcbiAgSHR0cEludGVyY2VwdG9yLFxuICBIdHRwSGFuZGxlcixcbiAgSHR0cFJlcXVlc3QsXG4gIEh0dHBFcnJvclJlc3BvbnNlXG59IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgZmlyc3QsIHN3aXRjaE1hcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuL2F1dGguc2VydmljZSc7XG5pbXBvcnQgeyBBVVRIX1NFUlZJQ0UgfSBmcm9tICcuL3Rva2Vucyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuXG4gIC8qKlxuICAgKiBJcyByZWZyZXNoIHRva2VuIGlzIGJlaW5nIGV4ZWN1dGVkXG4gICAqL1xuICBwcml2YXRlIHJlZnJlc2hJblByb2dyZXNzID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIE5vdGlmeSBhbGwgb3V0c3RhbmRpbmcgcmVxdWVzdHMgdGhyb3VnaCB0aGlzIHN1YmplY3RcbiAgICovXG4gIHByaXZhdGUgcmVmcmVzaFN1YmplY3Q6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7fVxuXG4gIC8qKlxuICAgKiBJbnRlcmNlcHQgYW4gb3V0Z29pbmcgYEh0dHBSZXF1ZXN0YFxuICAgKi9cbiAgcHVibGljIGludGVyY2VwdChcbiAgICByZXE6IEh0dHBSZXF1ZXN0PGFueT4sXG4gICAgZGVsZWdhdGU6IEh0dHBIYW5kbGVyXG4gICk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBpZiAodGhpcy5za2lwUmVxdWVzdChyZXEpKSB7XG4gICAgICByZXR1cm4gZGVsZWdhdGUuaGFuZGxlKHJlcSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMucHJvY2Vzc0ludGVyY2VwdChyZXEsIGRlbGVnYXRlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzIGFsbCB0aGUgcmVxdWVzdHMgdmlhIGN1c3RvbSBpbnRlcmNlcHRvcnMuXG4gICAqL1xuICBwcml2YXRlIHByb2Nlc3NJbnRlcmNlcHQoXG4gICAgb3JpZ2luYWw6IEh0dHBSZXF1ZXN0PGFueT4sXG4gICAgZGVsZWdhdGU6IEh0dHBIYW5kbGVyXG4gICk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBjb25zdCBjbG9uZTogSHR0cFJlcXVlc3Q8YW55PiA9IG9yaWdpbmFsLmNsb25lKCk7XG5cbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0KGNsb25lKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgocmVxOiBIdHRwUmVxdWVzdDxhbnk+KSA9PiBkZWxlZ2F0ZS5oYW5kbGUocmVxKSksXG4gICAgICAgIGNhdGNoRXJyb3IoKHJlczogSHR0cEVycm9yUmVzcG9uc2UpID0+IHRoaXMucmVzcG9uc2VFcnJvcihjbG9uZSwgcmVzKSlcbiAgICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVxdWVzdCBpbnRlcmNlcHRvci4gRGVsYXlzIHJlcXVlc3QgaWYgcmVmcmVzaCBpcyBpbiBwcm9ncmVzc1xuICAgKiBvdGhlcndpc2UgYWRkcyB0b2tlbiB0byB0aGUgaGVhZGVyc1xuICAgKi9cbiAgcHJpdmF0ZSByZXF1ZXN0KHJlcTogSHR0cFJlcXVlc3Q8YW55Pik6IE9ic2VydmFibGU8SHR0cFJlcXVlc3Q8YW55Pj4ge1xuICAgIGlmICh0aGlzLnJlZnJlc2hJblByb2dyZXNzKSB7XG4gICAgICByZXR1cm4gdGhpcy5kZWxheVJlcXVlc3QocmVxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5hZGRUb2tlbihyZXEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZhaWxlZCByZXF1ZXN0IGludGVyY2VwdG9yLCBjaGVjayBpZiBpdCBoYXMgdG8gYmUgcHJvY2Vzc2VkIHdpdGggcmVmcmVzaFxuICAgKi9cbiAgcHJpdmF0ZSByZXNwb25zZUVycm9yKFxuICAgIHJlcTogSHR0cFJlcXVlc3Q8YW55PixcbiAgICByZXM6IEh0dHBFcnJvclJlc3BvbnNlXG4gICk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBjb25zdCBhdXRoU2VydmljZTogQXV0aFNlcnZpY2UgPVxuICAgICAgdGhpcy5pbmplY3Rvci5nZXQ8QXV0aFNlcnZpY2U+KEFVVEhfU0VSVklDRSk7XG4gICAgY29uc3QgcmVmcmVzaFNob3VsZEhhcHBlbjogYm9vbGVhbiA9XG4gICAgICBhdXRoU2VydmljZS5yZWZyZXNoU2hvdWxkSGFwcGVuKHJlcyk7XG5cbiAgICBpZiAocmVmcmVzaFNob3VsZEhhcHBlbiAmJiAhdGhpcy5yZWZyZXNoSW5Qcm9ncmVzcykge1xuICAgICAgdGhpcy5yZWZyZXNoSW5Qcm9ncmVzcyA9IHRydWU7XG5cbiAgICAgIGF1dGhTZXJ2aWNlXG4gICAgICAgIC5yZWZyZXNoVG9rZW4oKVxuICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaEluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaFN1YmplY3QubmV4dCh0cnVlKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaEluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucmVmcmVzaFN1YmplY3QubmV4dChmYWxzZSk7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIGlmIChyZWZyZXNoU2hvdWxkSGFwcGVuICYmIHRoaXMucmVmcmVzaEluUHJvZ3Jlc3MpIHtcbiAgICAgIHJldHVybiB0aGlzLnJldHJ5UmVxdWVzdChyZXEsIHJlcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRocm93RXJyb3IocmVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYWNjZXNzIHRva2VuIHRvIGhlYWRlcnMgb3IgdGhlIHJlcXVlc3RcbiAgICovXG4gIHByaXZhdGUgYWRkVG9rZW4ocmVxOiBIdHRwUmVxdWVzdDxhbnk+KTogT2JzZXJ2YWJsZTxIdHRwUmVxdWVzdDxhbnk+PiB7XG4gICAgY29uc3QgYXV0aFNlcnZpY2U6IEF1dGhTZXJ2aWNlID1cbiAgICAgIHRoaXMuaW5qZWN0b3IuZ2V0PEF1dGhTZXJ2aWNlPihBVVRIX1NFUlZJQ0UpO1xuXG4gICAgcmV0dXJuIGF1dGhTZXJ2aWNlLmdldEFjY2Vzc1Rva2VuKClcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKHRva2VuOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICBpZiAodG9rZW4pIHtcbiAgICAgICAgICAgIGxldCBzZXRIZWFkZXJzOiB7IFtuYW1lOiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXSB9O1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIGF1dGhTZXJ2aWNlLmdldEhlYWRlcnMgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgc2V0SGVhZGVycyA9IGF1dGhTZXJ2aWNlLmdldEhlYWRlcnModG9rZW4pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgc2V0SGVhZGVycyA9IHsgQXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHJlcS5jbG9uZSh7IHNldEhlYWRlcnMgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHJlcTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpcnN0KClcbiAgICAgICk7XG4gIH1cblxuICAvKipcbiAgICogRGVsYXkgcmVxdWVzdCwgYnkgc3Vic2NyaWJpbmcgb24gcmVmcmVzaCBldmVudCwgb25jZSBpdCBmaW5pc2hlZCwgcHJvY2VzcyBpdFxuICAgKiBvdGhlcndpc2UgdGhyb3cgZXJyb3JcbiAgICovXG4gIHByaXZhdGUgZGVsYXlSZXF1ZXN0KHJlcTogSHR0cFJlcXVlc3Q8YW55Pik6IE9ic2VydmFibGU8SHR0cFJlcXVlc3Q8YW55Pj4ge1xuICAgIHJldHVybiB0aGlzLnJlZnJlc2hTdWJqZWN0LnBpcGUoXG4gICAgICBmaXJzdCgpLFxuICAgICAgc3dpdGNoTWFwKChzdGF0dXM6IGJvb2xlYW4pID0+XG4gICAgICAgIHN0YXR1cyA/IHRoaXMuYWRkVG9rZW4ocmVxKSA6IHRocm93RXJyb3IocmVxKVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0cnkgcmVxdWVzdCwgYnkgc3Vic2NyaWJpbmcgb24gcmVmcmVzaCBldmVudCwgb25jZSBpdCBmaW5pc2hlZCwgcHJvY2VzcyBpdFxuICAgKiBvdGhlcndpc2UgdGhyb3cgZXJyb3JcbiAgICovXG4gIHByaXZhdGUgcmV0cnlSZXF1ZXN0KFxuICAgIHJlcTogSHR0cFJlcXVlc3Q8YW55PixcbiAgICByZXM6IEh0dHBFcnJvclJlc3BvbnNlXG4gICk6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBjb25zdCBodHRwOiBIdHRwQ2xpZW50ID1cbiAgICAgIHRoaXMuaW5qZWN0b3IuZ2V0PEh0dHBDbGllbnQ+KEh0dHBDbGllbnQpO1xuXG4gICAgcmV0dXJuIHRoaXMucmVmcmVzaFN1YmplY3QucGlwZShcbiAgICAgIGZpcnN0KCksXG4gICAgICBzd2l0Y2hNYXAoKHN0YXR1czogYm9vbGVhbikgPT5cbiAgICAgICAgc3RhdHVzID8gaHR0cC5yZXF1ZXN0KHJlcSkgOiB0aHJvd0Vycm9yKHJlcyB8fCByZXEpXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgcmVxdWVzdCBtdXN0IGJlIHNraXBwZWQgYnkgaW50ZXJjZXB0b3IuXG4gICAqL1xuICBwcml2YXRlIHNraXBSZXF1ZXN0KHJlcTogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIGNvbnN0IHNraXBSZXF1ZXN0ID0gdGhpcy5leGVjKCdza2lwUmVxdWVzdCcsIHJlcSk7XG4gICAgY29uc3QgdmVyaWZ5UmVmcmVzaFRva2VuID0gdGhpcy5leGVjKCd2ZXJpZnlSZWZyZXNoVG9rZW4nLCByZXEpO1xuXG4gICAgLy8gZGVwcmVjYXRlZCwgd2lsbCBiZSByZW1vdmVkIHNvb25cbiAgICBjb25zdCB2ZXJpZnlUb2tlblJlcXVlc3QgPSB0aGlzLmV4ZWMoJ3ZlcmlmeVRva2VuUmVxdWVzdCcsIHJlcS51cmwpO1xuXG4gICAgcmV0dXJuIHNraXBSZXF1ZXN0IHx8IHZlcmlmeVJlZnJlc2hUb2tlbiB8fCB2ZXJpZnlUb2tlblJlcXVlc3Q7XG4gIH1cblxuICAvKipcbiAgICogRXhlYyBvcHRpb25hbCBtZXRob2QsIHdpbGwgYmUgcmVtb3ZlZCBpbiB1cGNvbWluZyB1cGRhdGVzLlxuICAgKiBUZW1wIG1ldGhvZCB1bnRpbCBgdmVyaWZ5VG9rZW5SZXF1ZXN0YCB3aWxsIGJlIGNvbXBsZXRlbHkgcmVwbGFjZWQgd2l0aCBza2lwUmVxdWVzdFxuICAgKi9cbiAgcHJpdmF0ZSBleGVjKG1ldGhvZDogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkge1xuICAgIGNvbnN0IGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSA9XG4gICAgICB0aGlzLmluamVjdG9yLmdldDxBdXRoU2VydmljZT4oQVVUSF9TRVJWSUNFKTtcblxuICAgIGlmICh0eXBlb2YgYXV0aFNlcnZpY2VbbWV0aG9kXSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgcmV0dXJuIGF1dGhTZXJ2aWNlW21ldGhvZF0oLi4uYXJncyk7XG4gICAgfVxuICB9XG5cbn1cbiIsImltcG9ydCB7IE5nTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIVFRQX0lOVEVSQ0VQVE9SUyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgUHVibGljR3VhcmQgfSBmcm9tICcuL3B1YmxpYy5ndWFyZCc7XG5pbXBvcnQgeyBQcm90ZWN0ZWRHdWFyZCB9IGZyb20gJy4vcHJvdGVjdGVkLmd1YXJkJztcbmltcG9ydCB7IEF1dGhJbnRlcmNlcHRvciB9IGZyb20gJy4vYXV0aC5pbnRlcmNlcHRvcic7XG5cbkBOZ01vZHVsZSh7XG4gIHByb3ZpZGVyczogW1xuICAgIFB1YmxpY0d1YXJkLFxuICAgIFByb3RlY3RlZEd1YXJkLFxuICAgIEF1dGhJbnRlcmNlcHRvcixcbiAgICB7XG4gICAgICBwcm92aWRlOiBIVFRQX0lOVEVSQ0VQVE9SUyxcbiAgICAgIHVzZUNsYXNzOiBBdXRoSW50ZXJjZXB0b3IsXG4gICAgICBtdWx0aTogdHJ1ZSxcbiAgICB9XG4gIF1cbn0pXG5leHBvcnQgY2xhc3MgQXV0aE1vZHVsZSB7XG59XG4iXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBTUE7Ozs7O0lBQUE7S0ErREM7SUFBRCxrQkFBQztDQUFBOzs7Ozs7QUNyRUQ7QUFFQSxJQUFhLFlBQVksR0FBRyxJQUFJLGNBQWMsQ0FBQyxjQUFjLENBQUM7O0FBQzlELElBQWEsd0JBQXdCLEdBQUcsSUFBSSxjQUFjLENBQUMsMEJBQTBCLENBQUM7O0FBQ3RGLElBQWEsMkJBQTJCLEdBQUcsSUFBSSxjQUFjLENBQUMsNkJBQTZCLENBQUM7Ozs7OztBQ0o1Rjs7Ozs7Ozs7QUFzQkE7SUFHRSxxQkFDZ0MsV0FBd0IsRUFDVCx3QkFBZ0MsRUFDckUsTUFBYztRQUZRLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ1QsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUFRO1FBQ3JFLFdBQU0sR0FBTixNQUFNLENBQVE7S0FDcEI7Ozs7Ozs7Ozs7SUFLRyxpQ0FBVzs7Ozs7O0lBQWxCLFVBQ0UsTUFBOEIsRUFDOUIsS0FBMEI7UUFGNUIsaUJBY0M7UUFWQyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFO2FBQ25DLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBQyxZQUFxQjtZQUM5QixJQUFJLFlBQVksSUFBSSxDQUFDLEtBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ2hELEtBQUksQ0FBQyxRQUFRLENBQUMsS0FBSSxDQUFDLHdCQUF3QixDQUFDLENBQUM7Z0JBRTdDLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7WUFFRCxPQUFPLElBQUksQ0FBQztTQUNiLENBQUMsQ0FBQyxDQUFDO0tBQ1A7Ozs7Ozs7Ozs7SUFLTSxzQ0FBZ0I7Ozs7OztJQUF2QixVQUNFLEtBQTZCLEVBQzdCLEtBQTBCO1FBRTFCLE9BQU8s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